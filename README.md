# Chess Move Predictor

Нейросетевая модель для предсказания шахматных ходов по позиции на доске с REST API и Docker поддержкой.

## Задача

По любой шахматной позиции в формате FEN предсказать следующий ход:
- **Вход**: позиция на доске (FEN строка)
- **Выход**: список возможных ходов с вероятностями

## Как это работает

1. **Преобразование доски**: FEN → тензор 8×8×12 (каждый тип фигуры - отдельный канал)
2. **Дополнительные признаки**: рокировки, защищенность короля, количество фигур и атак и тд.
3. **Нейросеть**: сверточная сеть с residual блоками и SE (Squeeze-and-Excitation) модулями
4. **Предсказание**: вероятности для всех возможных ходов с учетом легальных ходов

## Метрики качества

После 8 эпох обучения модель показывает:

| Метрика | Значение | Описание |
|---------|----------|-----------|
| **Accuracy@1** | 36.1% | Правильный ход на первом месте |
| **Accuracy@3** | 60.2% | Правильный ход в топ-3 |
| **Accuracy@5** | 71.4% | Правильный ход в топ-5 |
| **Train Loss** | 1.5 | Ошибка на обучающей выборке |
| **Validation Loss** | 2.2 | Ошибка на валидационной выборке |

## Пример:
#### fen = "rnb2rk1/pp3ppp/4p1n1/q1pP4/3P4/1QN1P1B1/PP3PPP/R3KB1R b KQ - 0 11"
#### Зеленая стрелка - предсказание модели. Логичный ход и топ-3 по Stockfish 17.1
<img width="430" height="415" alt="image" src="https://github.com/user-attachments/assets/4d8958de-4176-4189-9e01-4e4b993fe6b6" />

## Быстрый запуск

### Использование Docker (рекомендуется)
Образ доступен по ссылке: https://hub.docker.com/repository/docker/shut77/chess-predictor/general  

```bash
# Клонировать репозиторий
git clone https://github.com/shut77/chess_neiro_predict.git
cd chess_neiro_predict

# Запуск через Docker Compose
docker-compose up --build

# Или через Docker Hub (мой готовый образ)
docker run -p 8000:8000 shut77/chess-predictor:v2
```

После запуска API доступно по адресу http://localhost:8000

### Локальный запуск (для разработки)

```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск API
python run_local.py
```

## API Использование

### Документация
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

### Пример запроса

```bash
curl -X POST "http://localhost:8000/predict" \
     -H "Content-Type: application/json" \
     -d '{
       "fen": "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",
       "top_k": 5
     }'
```

### Проверка здоровья

```bash
curl http://localhost:8000/health
```

## Структура проекта

```
chess_neiro_predict/
├── src/                     # Исходный код API и модели
│   ├── main.py              # FastAPI приложение
│   ├── mymodel.py           # Архитектура нейросети с SE блоками
│   ├── features.py          # Преобразование FEN в тензоры и доп признаки
│   ├── training.py          # Обучение и предсказание
│   └── move.py              # Генерация возможных ходов
├── notebook/                # Jupyter ноутбуки и модель
│   ├── modeling.ipynb       # Обучение модели
│   ├── analys.ipynb         # Анализ данных
│   └── best_chess_model.pt  # Обученная модель
├── docker-compose.yml       # Docker Compose конфигурация
├── Dockerfile              # Docker образ
├── requirements.txt        # Python зависимости
├── run_local.py            # Скрипт локального запуска
├── test_api.py             # Тесты API
├── Makefile                # Автоматизация задач
└── README_DOCKER.md        # Подробная документация по Docker
```


## Возможности
- REST API для предсказания ходов
- Поддержка GPU/CPU (сейчас используется только CPU для уменьшения размера образа)
- Оптимизация для пакетной обработки
- Автоматическая валидация FEN строк
- Health check endpoint
- Docker контейнеризация
- Топ-K предсказаний с вероятностями
- Быстрое предсказание (~50 мс на ход)

## Будущие улучшения
- Подбор оптимальной архитектуры модели и анализ других метрик
- Персональные модели для игроков, чтобы предсказывать ходы конкретного игрока с учетом его стиля:
  ### Что нужно:
  500-1000 партий одного игрока для надежной статистики
  Данные о его типичных дебютах, тактических предпочтениях
  Информация об агрессивности/осторожности стиля
  ### Как это будет работать:
  Базовая модель (текущая) - понимает общие шахматные принципы
  Персональный слой - дообучается на ходах конкретного игрока
  Смешанное предсказание = 70% общая логика + 30% стиль игрока
  ### Отличия от общей модели:
  Учитывает любимые дебюты (например, игрок всегда начинает e2-e4)
  Улавливает тактические предпочтения (жертвы, позиционная игра)
  Помнит типичные ошибки и сильные стороны

Модель успешно предсказывает сильные шахматные ходы и может использоваться для анализа позиций и помощи в изучении шахмат.
